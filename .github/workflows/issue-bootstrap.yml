name: Codex Worker Issue Bootstrap

on:
  workflow_call:
    inputs:
      issue_number:
        type: number
        required: true
      issue_title:
        type: string
        required: true
      issue_body:
        type: string
        required: false
      comment_body:
        type: string
        required: false
      model:
        type: string
        required: false
      reasoning_effort:
        type: string
        required: false
    secrets:
      OPENAI_API_KEY:
        required: true

permissions:
  contents: read
  issues: write
  actions: read

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Codex CLI
        run: npm install -g @openai/codex@0.93.0

      - name: Set Codex paths
        shell: bash
        run: |
          set -euo pipefail
          codex_home="$RUNNER_TEMP/codex-home"
          echo "CODEX_HOME=$codex_home" >> "$GITHUB_ENV"
          echo "CODEX_STATE_DIR=$codex_home/.codex" >> "$GITHUB_ENV"
          echo "CODEX_SESSIONS_PATH=$codex_home/.codex/sessions" >> "$GITHUB_ENV"

      - name: Find session artifact
        id: find_artifact
        if: ${{ inputs.comment_body != '' }}
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail

          missing_session=true
          artifact_run_id=""

          if ! artifact_run_id=$(gh api "repos/${{ github.repository }}/actions/artifacts?per_page=100" \
            --jq '[.artifacts[] | select(.name=="codex-worker-session-${{ inputs.issue_number }}") | select(.expired==false)] | sort_by(.created_at) | last | .workflow_run.id'); then
            echo "missing_session=true" >> "$GITHUB_OUTPUT"
            echo "run_id=" >> "$GITHUB_OUTPUT"
            echo "Failed to list artifacts; cannot resume. Ensure actions: read permission." > /tmp/codex_output.txt
            echo "codex_exit=1" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "$artifact_run_id" = "null" ] || [ -z "$artifact_run_id" ]; then
            echo "missing_session=true" >> "$GITHUB_OUTPUT"
            echo "run_id=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "missing_session=false" >> "$GITHUB_OUTPUT"
          echo "run_id=$artifact_run_id" >> "$GITHUB_OUTPUT"

      - name: Download session artifact
        id: download_session
        if: ${{ inputs.comment_body != '' && steps.find_artifact.outputs.missing_session == 'false' }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: codex-worker-session-${{ inputs.issue_number }}
          run-id: ${{ steps.find_artifact.outputs.run_id }}
          github-token: ${{ github.token }}
          repository: ${{ github.repository }}
          path: ${{ runner.temp }}/codex-session

      - name: Restore session artifact
        id: restore
        if: ${{ inputs.comment_body != '' }}
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ steps.find_artifact.outputs.missing_session }}" = "true" ]; then
            echo "missing_session=true" >> "$GITHUB_OUTPUT"
            echo "Session artifact not found; cannot resume." > /tmp/codex_output.txt
            echo "codex_exit=1" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "${{ steps.download_session.outcome }}" != "success" ]; then
            echo "missing_session=true" >> "$GITHUB_OUTPUT"
            echo "Session artifact not found; cannot resume." > /tmp/codex_output.txt
            echo "codex_exit=1" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          src="${{ runner.temp }}/codex-session"
          if [ -d "$src/sessions" ] && [ ! -f "$src/history.jsonl" ]; then
            src="$src/sessions"
          fi

          if [ ! -e "$src" ]; then
            echo "missing_session=true" >> "$GITHUB_OUTPUT"
            echo "Session artifact missing contents; cannot resume." > /tmp/codex_output.txt
            echo "codex_exit=1" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          dest="$CODEX_STATE_DIR"
          mkdir -p "$dest"
          cp -a "$src/." "$dest/"

          echo "missing_session=false" >> "$GITHUB_OUTPUT"

      - name: Run Codex
        id: codex
        if: ${{ !(inputs.comment_body != '' && steps.restore.outputs.missing_session == 'true') }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ISSUE_TITLE: ${{ inputs.issue_title }}
          ISSUE_BODY: ${{ inputs.issue_body }}
          COMMENT_BODY: ${{ inputs.comment_body }}
          MODEL: ${{ inputs.model }}
          REASONING_EFFORT: ${{ inputs.reasoning_effort }}
          HOME: ${{ env.CODEX_HOME }}
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "$OPENAI_API_KEY" ]; then
            echo "OPENAI_API_KEY is missing. Add it as a repo/org secret." > /tmp/codex_output.txt
            echo "session_id=" >> "$GITHUB_OUTPUT"
            echo "codex_exit=1" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          printenv OPENAI_API_KEY | codex login --with-api-key

          prompt_file=$(mktemp)
          if [ -n "$COMMENT_BODY" ]; then
            printf '%s\n' "$COMMENT_BODY" > "$prompt_file"
          else
            {
              echo "# Issue"
              echo "Title: $ISSUE_TITLE"
              echo
              echo "Body:"
              echo "$ISSUE_BODY"
            } > "$prompt_file"
          fi

          set +e
          codex_args=()
          if [ -n "$MODEL" ]; then
            codex_args+=(--model "$MODEL")
          fi
          if [ -n "$REASONING_EFFORT" ]; then
            codex_args+=(-c "model_reasoning_effort=$REASONING_EFFORT")
          fi

          if [ -n "$COMMENT_BODY" ]; then
            printf '%s' "$(cat "$prompt_file")" | codex exec "${codex_args[@]}" resume --last 2>&1 | tee /tmp/codex_output.txt
          else
            codex exec "${codex_args[@]}" "$(cat "$prompt_file")" 2>&1 | tee /tmp/codex_output.txt
          fi
          codex_exit=${PIPESTATUS[0]}
          set -e

          echo "codex_exit=$codex_exit" >> "$GITHUB_OUTPUT"

      - name: Strip Codex auth
        if: ${{ steps.codex.outcome == 'success' }}
        shell: bash
        run: |
          set -euo pipefail
          rm -f "$CODEX_STATE_DIR/auth.json"

      - name: Upload session artifact
        if: ${{ steps.codex.outcome == 'success' }}
        uses: actions/upload-artifact@v4
        with:
          name: codex-worker-session-${{ inputs.issue_number }}
          path: ${{ env.CODEX_STATE_DIR }}
          retention-days: 7
          overwrite: true
          if-no-files-found: error
          include-hidden-files: true

      - name: Comment on issue
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          FIND_CODEX_EXIT: ${{ steps.find_artifact.outputs.codex_exit }}
          CODEX_EXIT: ${{ steps.restore.outputs.codex_exit }}
          CODEX_CODEX_EXIT: ${{ steps.codex.outputs.codex_exit }}
        shell: bash
        run: |
          set -euo pipefail

          codex_exit="${CODEX_EXIT:-${FIND_CODEX_EXIT:-$CODEX_CODEX_EXIT}}"

          status="success"
          if [ -n "$codex_exit" ] && [ "$codex_exit" -ne 0 ]; then
            status="failed (exit $codex_exit)"
          fi

          response_file=/tmp/codex_output.txt
          if [ ! -f "$response_file" ]; then
            echo "(no output)" > "$response_file"
          fi

          comment_body_file=$(mktemp)
          echo "**Codex Worker** response ($status)" >> "$comment_body_file"
          echo >> "$comment_body_file"
          cat "$response_file" >> "$comment_body_file"

          gh api \
            --method POST \
            "repos/${{ github.repository }}/issues/$ISSUE_NUMBER/comments" \
            -f body="$(cat "$comment_body_file")"
