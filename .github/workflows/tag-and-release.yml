name: tag-and-release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  tag-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Tag and release via workflow-agent
        uses: sudden-network/workflow-agent@v1
        with:
          agent_auth_file: ${{ secrets.CODEX_AUTH_JSON }}
          github_token: ${{ github.token }}
          prompt: |
            Goal: on every push to main, move v{major} to the current commit. If package.json version changed, create v{version} and a GitHub release for it.

            Inputs:
            - owner: ${{ github.repository_owner }}
            - repo: ${{ github.event.repository.name }}
            - before_sha: ${{ github.event.before }}
            - after_sha: ${{ github.sha }}

            Steps:
            1) Fetch `package.json` at after_sha:
               GET /repos/{owner}/{repo}/contents/package.json?ref={after_sha}
               Read `version` as {version} and derive {major} (first number before the dot).

            2) Fetch `package.json` at before_sha:
               GET /repos/{owner}/{repo}/contents/package.json?ref={before_sha}
               Read `version` as {before_version}.

            3) If versions differ, check if tag `v{version}` (full version, e.g. 1.2.3) exists via:
               GET /repos/{owner}/{repo}/git/ref/tags/v{version}
               If it does not exist, create it with:
               POST /repos/{owner}/{repo}/git/refs
               { "ref": "refs/tags/v{version}", "sha": "{after_sha}" }
               If the tag already exists, skip release creation.

            4) If you created a new `v{version}` tag, create a release:
               - Check if release exists:
                 GET /repos/{owner}/{repo}/releases/tags/v{version}
                 If it exists, stop.
               - Find the previous semver tag by listing tags:
                 GET /repos/{owner}/{repo}/tags
                 Pick the first tag that matches vX.Y.Z and is not v{version}.
               - Generate release notes:
                 POST /repos/{owner}/{repo}/releases/generate-notes
                 { "tag_name": "v{version}", "target_commitish": "{after_sha}", "previous_tag_name": "<previous tag>" }
                 If no previous tag, omit previous_tag_name.
               - Create the release:
                 POST /repos/{owner}/{repo}/releases
                 { "tag_name": "v{version}", "name": "v{version}", "body": "<generated notes>" }
               - If a release for v{version} already exists, do nothing.

            5) Move `v{major}` to the current SHA:
               PATCH /repos/{owner}/{repo}/git/refs/tags/v{major}
               { "sha": "{after_sha}", "force": true }
               If the ref is missing, create it with POST /repos/{owner}/{repo}/git/refs.

            Log what you did.
